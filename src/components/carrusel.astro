---
import '../style/carrusel.css';
import dataRaw from '../../public/data/carrusel.json';
import Link from '@components/ui/link.astro';

import chestudio from '../assets/imgs/portadas/chestudio.webp';
import ciberdelitos from '../assets/imgs/portadas/ciberdelitos.webp';
import recuperacionCuenta from '../assets/imgs/portadas/recuperacion-cuenta-carrusel.webp';
import publicaciones from '../assets/imgs/portadas/publicaciones.webp';

const fondoMap = {
  "chestudio.webp": chestudio,
  "ciberdelitos.webp": ciberdelitos,
  "recuperacion-cuenta-carrusel.webp": recuperacionCuenta,
  "publicaciones.webp": publicaciones,
};

const data = dataRaw.map(item => {
  const fondoImport = fondoMap[item.fondo];
  return {
    ...item,
    fondo: fondoImport ? (fondoImport.src || fondoImport) : item.fondo,
  };
});

const dataJSON = JSON.stringify(data);
let currentIndex = 0;
const current = data[currentIndex];

function esLinkExterno(url) {
  try {
    const link = new URL(url, import.meta.env.SITE || 'https://chestudioabogados.com');
    return link.hostname !== (new URL(import.meta.env.SITE || 'https://chestudioabogados.com')).hostname;
  } catch {
    return false;
  }
}

const esExterno = esLinkExterno(current.botonLink);
---

<div class="main-container" id="main-container" data-carrusel={dataJSON}>
  <div id="bg-prev" class="background-layer" style={`background-image: linear-gradient(180deg, #002d4255, #002d42), url('${current.fondo}')`}></div>
  <div id="bg-next" class="background-layer"></div>

  <div class="content" id="content">
    <h1 id="slide-title">{current.titulo}</h1>
    <h2 id="slide-subtitle" class="subtitle" style={current.subtitulo ? '' : 'display:none'}>
      {current.subtitulo}
    </h2>
    <p id="slide-bajada" style={current.bajada ? '' : 'display:none'}>
      {current.bajada}
    </p>
    <Link
      id="slide-button"
      href={current.botonLink}
      target={esExterno ? "_blank" : "_self"}
      rel={esExterno ? "noopener noreferrer" : undefined}
      class="pill uppercase"
    >
      {current.botonTexto}
    </Link>
  </div>

  <div class="carousel-controls">
    <button id="prev-btn" aria-label="Previous Slide">&#10094;</button>
    <div class="indicators" id="indicators"></div>
    <button id="next-btn" aria-label="Next Slide">&#10095;</button>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("main-container");
    const data = JSON.parse(container.getAttribute("data-carrusel"));

    const bgPrev = document.getElementById("bg-prev");
    const bgNext = document.getElementById("bg-next");
    const content = document.getElementById("content");
    const titleEl = document.getElementById("slide-title");
    const subtitleEl = document.getElementById("slide-subtitle");
    const bajadaEl = document.getElementById("slide-bajada");
    const buttonEl = document.getElementById("slide-button");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const indicatorsContainer = document.getElementById("indicators");

    let currentIndex = 0;
    const totalSlides = data.length;
    let isAnimating = false;
    let autoChange = true;

    for (let i = 0; i < totalSlides; i++) {
      const dot = document.createElement("div");
      dot.classList.add("dot");
      if (i === currentIndex) dot.classList.add("active");
      indicatorsContainer.appendChild(dot);
    }

    function updateIndicators(index) {
      const dots = indicatorsContainer.querySelectorAll(".dot");
      dots.forEach((dot, i) => {
        dot.classList.toggle("active", i === index);
      });
    }

    bgPrev.style.opacity = "1";
    bgNext.style.opacity = "0";

    function esLinkExterno(url) {
      try {
        const link = new URL(url, window.location.origin);
        return link.hostname !== window.location.hostname;
      } catch {
        return false;
      }
    }

    function setContent(index) {
      const current = data[index];

      titleEl.textContent = current.titulo;

      if (current.subtitulo && current.subtitulo.trim() !== "") {
        subtitleEl.style.display = "block";
        subtitleEl.textContent = current.subtitulo;
      } else {
        subtitleEl.style.display = "none";
        subtitleEl.textContent = "";
      }

      if (current.bajada && current.bajada.trim() !== "") {
        bajadaEl.style.display = "block";
        bajadaEl.textContent = current.bajada;
      } else {
        bajadaEl.style.display = "none";
        bajadaEl.textContent = "";
      }

      buttonEl.href = current.botonLink;
      buttonEl.textContent = current.botonTexto;

      if (esLinkExterno(current.botonLink)) {
        buttonEl.target = "_blank";
        buttonEl.rel = "noopener noreferrer";
      } else {
        buttonEl.target = "_self";
        buttonEl.removeAttribute("rel");
      }

      bgNext.style.backgroundImage = `linear-gradient(180deg, #002d4255, #002d42), url('${current.fondo}')`;
    }

    function animateChange(newIndex) {
      if (isAnimating || newIndex === currentIndex) return;
      isAnimating = true;

      content.classList.add("slide-out");

      content.addEventListener("animationend", () => {
        content.classList.remove("slide-out");
        setContent(newIndex);

        bgPrev.style.transition = "opacity 0.8s ease-in-out";
        bgNext.style.transition = "opacity 0.8s ease-in-out";
        bgPrev.style.opacity = "0";
        bgNext.style.opacity = "1";

        content.classList.add("slide-in");

        content.addEventListener(
          "animationend",
          () => {
            content.classList.remove("slide-in");

            bgPrev.style.backgroundImage = bgNext.style.backgroundImage;
            bgPrev.style.opacity = "1";
            bgNext.style.opacity = "0";

            currentIndex = newIndex;
            updateIndicators(currentIndex);

            isAnimating = false;
          },
          { once: true }
        );
      }, { once: true });
    }

    setContent(currentIndex);

    function userInteracted() {
      autoChange = false;
    }

    prevBtn.addEventListener("click", () => {
      userInteracted();
      const newIndex = (currentIndex - 1 + totalSlides) % totalSlides;
      animateChange(newIndex);
    });

    nextBtn.addEventListener("click", () => {
      userInteracted();
      const newIndex = (currentIndex + 1) % totalSlides;
      animateChange(newIndex);
    });

    setInterval(() => {
      if (autoChange) {
        const newIndex = (currentIndex + 1) % totalSlides;
        animateChange(newIndex);
      }
    }, 4000);
  });
</script>
